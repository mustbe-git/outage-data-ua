name: Scheduled Pipeline
permissions:
  contents: write

on:
  schedule:
    # Runs every 5 minutes at :00, :05, :10, :15, :20, :25, :30, :35, :40, :45, :50, :55
    # NOTE: GitHub Actions cron uses UTC time. Adjust if you need specific local times.
    - cron: '*/5 * * * *'
  # Allows manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      region:
        description: 'Optional: process only this region id (must match a key in REGION_SOURCES_JSON)'
        required: false
        type: string

jobs:
  # Job 1: Fetch and parse HTML for all regions
  fetch-and-parse:
    name: Fetch and parse HTML
    runs-on: ubuntu-latest
    outputs:
      regions: ${{ steps.set-matrix.outputs.regions }}
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
    env:
      REGION_SOURCES_JSON: ${{ secrets.REGION_SOURCES_JSON }}
      REGION: ${{ github.event.inputs.region }}
      TARGET_BRANCH: main
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Ensure Playwright Chromium is installed
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx --yes playwright install --with-deps chromium

      - name: Fetch HTML for each region (with Playwright fallback)
        shell: bash
        run: |
          set -euo pipefail
          echo "Started at $(date -u +"%Y-%m-%dT%H:%M:%SZ") (UTC)"

          # Basic validation
          if [ -z "${REGION_SOURCES_JSON:-}" ]; then
            echo "REGION_SOURCES_JSON is empty or not set. Ensure repository secret is configured." >&2
            exit 0
          fi

          mkdir -p outputs

          # If REGION is set — pass it to the script; otherwise fetch all
          if [ -n "${REGION:-}" ]; then
            echo "[INFO] Running Playwright fetcher for region='$REGION'"
            node scripts/fetch_regions_playwright.mjs "$REGION" || true
          else
            echo "[INFO] Running Playwright fetcher for all regions"
            node scripts/fetch_regions_playwright.mjs || true
          fi

          # Always exit 0 to not fail the pipeline on partial fetch issues
          exit 0

      - name: Parse DisconSchedule.fact into JSON per region (skip failures)
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Parsing outputs/*.html into data/*.json via Node batch parser"
          node scripts/batch_parse.mjs

      - name: Check for data changes
        id: check-changes
        shell: bash
        run: |
          set -euo pipefail
          changed_files=$(git status --porcelain data/ | grep '\.json$' | cut -c4- || true)
          
          if [ -z "$changed_files" ]; then
            echo "[INFO] No data changes detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "[INFO] Detected changes in: $changed_files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload JSON data as artifact
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: json-data
          path: data/*.json
          retention-days: 1

      - name: Set matrix for rendering
        id: set-matrix
        env:
          REGION_SOURCES_JSON: ${{ secrets.REGION_SOURCES_JSON }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${REGION:-}" ]; then
            # Manual trigger with specific region
            echo "regions=[\"${REGION}\"]" >> $GITHUB_OUTPUT
          else
            # Get all regions from secret
            regions=$(node scripts/list_regions.mjs)
            echo "regions=$regions" >> $GITHUB_OUTPUT
          fi

  # Job 2: Render images for each region in parallel
  render-images:
    name: Render ${{ matrix.region }}
    runs-on: ubuntu-latest
    needs: fetch-and-parse
    if: needs.fetch-and-parse.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        region: ${{ fromJson(needs.fetch-and-parse.outputs.regions) }}
    env:
      TARGET_BRANCH: main
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Ensure Playwright Chromium is installed
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx --yes playwright install --with-deps chromium

      - name: Download JSON data artifact
        uses: actions/download-artifact@v4
        with:
          name: json-data
          path: data/

      - name: Render images for ${{ matrix.region }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Rendering images for region='${{ matrix.region }}'"
          node scripts/batch_render.mjs --region "${{ matrix.region }}"

      - name: Compress images with pngquant
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Compressing PNG images for ${{ matrix.region }}..."
          find images/${{ matrix.region }} -name "*.png" -print0 2>/dev/null | xargs -0 -P 4 -I {} npx pngquant-bin --force --ext .png --quality 65-80 --skip-if-larger "{}" || true
          echo "[INFO] Compression complete."

      - name: Upload images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-${{ matrix.region }}
          path: images/${{ matrix.region }}/
          retention-days: 1

  # Job 3: Commit all changes (JSON + images) in a single commit
  commit-all:
    name: Commit all changes
    runs-on: ubuntu-latest
    needs: [fetch-and-parse, render-images]
    if: needs.fetch-and-parse.outputs.has_changes == 'true' && github.ref_name == 'main'
    env:
      TARGET_BRANCH: main
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download JSON data artifact
        uses: actions/download-artifact@v4
        with:
          name: json-data
          path: data/

      - name: Download all image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: images-*
          path: images/

      - name: Verify and fix image structure
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Verifying image structure"
          
          # Each artifact creates a folder like images/images-kyiv/
          # We need to move contents from images/images-{region}/ to images/{region}/
          
          # Create temp directory outside of images/
          mkdir -p /tmp/images-restructure
          
          for artifact_dir in images/images-*; do
            if [ -d "$artifact_dir" ]; then
              # Extract region name from artifact directory name
              # images/images-kyiv -> kyiv
              region=$(basename "$artifact_dir" | sed 's/^images-//')
              
              echo "[INFO] Processing region: $region"
              echo "[INFO] Artifact dir: $artifact_dir"
              
              # Move the region folder from artifact to temp, then to final location
              # The artifact contains: images/images-kyiv/{region}/...
              # We need to move it to: images/{region}/...
              if [ -d "$artifact_dir/$region" ]; then
                # First move to temp outside images/
                mv "$artifact_dir/$region" "/tmp/images-restructure/$region"
                # Remove artifact directory
                rm -rf "$artifact_dir"
                # Move from temp to final location
                mv "/tmp/images-restructure/$region" "images/$region"
                echo "[INFO] Moved $region images to images/$region/"
              else
                echo "[WARN] Expected structure not found in $artifact_dir"
                ls -la "$artifact_dir" || true
              fi
            fi
          done
          
          # Cleanup temp directory
          rm -rf /tmp/images-restructure
          
          echo "[INFO] Final image structure:"
          ls -la images/ || true
          echo "[INFO] Contents of each region folder:"
          for region_dir in images/*/; do
            if [ -d "$region_dir" ]; then
              echo "[INFO] $region_dir:"
              ls -la "$region_dir" | head -10 || true
            fi
          done

      - name: Commit and push all changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "[INFO] Preparing to commit all changes (JSON + images) to ${TARGET_BRANCH}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          echo "[INFO] Changed files:"
          git status --porcelain || true

          # Add all JSON and image files
          git add data/*.json 2>/dev/null || true
          git add images/** 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "[INFO] No changes detected — skipping commit"
            exit 0
          fi

          echo "[INFO] Staged files:"
          git diff --name-only --cached

          commit_msg="chore: update schedules and images — run #${GITHUB_RUN_ID}"
          git commit -m "$commit_msg"

          # Retry push up to 3 times
          for attempt in 1 2 3; do
            if git push origin HEAD:"$TARGET_BRANCH"; then
              echo "[OK] Pushed all updates to $TARGET_BRANCH"
              exit 0
            fi
            echo "[WARN] Push failed (attempt $attempt). Fetching and rebasing..."
            git fetch origin "$TARGET_BRANCH" --depth=1
            git rebase "origin/$TARGET_BRANCH" || true
            sleep $((attempt*2))
          done

          echo "[ERROR] Failed to push changes after retries" >&2
          exit 1
